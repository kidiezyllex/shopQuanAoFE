import{a as P,j as e,an as b,aA as ce,U as oe,V as de,E as H,R as S,B as f,ar as me,k as j,ac as he,ab as xe,q as O,aa as ue,A as ge,m as Q,at as pe,aB as fe,a6 as R,_ as je,a2 as ye,a5 as Ne}from"./index-Dpx_4rWJ.js";import{R as be,P as ve,C as M,f as ke,X as we,T as K,O as U,g as _,D as Se,a as Ce,b as De,c as Te,d as Ve}from"./dialog-BuHyDe_9.js";import{S as X}from"./scroll-area-jH8Oe1ZO.js";import{u as Ie}from"./useCartStore-XJ4QOmkb.js";import{S as Pe}from"./separator-vZGg2kit.js";import{u as qe}from"./useToast-DwXsNIYN.js";import{f as u}from"./formatters-BzOSFyyi.js";import{a as Ee,u as Le}from"./voucher-C7mr4xZE.js";import{B as Ae}from"./badge-CA2Kv9aL.js";const Re=be,ze=ve,J=P.forwardRef(({className:c,...i},d)=>e.jsx(U,{className:b("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",c),...i,ref:d}));J.displayName=U.displayName;const Ge=ce("fixed z-50 gap-4 bg-background p-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),W=P.forwardRef(({side:c="right",className:i,children:d,...y},v)=>e.jsxs(ze,{children:[e.jsx(J,{}),e.jsxs(M,{ref:v,className:b(Ge({side:c}),i),...y,children:[e.jsxs(ke,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[e.jsx(we,{className:"h-6 w-6"}),e.jsx("span",{className:"sr-only",children:"Close"})]}),d]})]}));W.displayName=M.displayName;const Y=({className:c,...i})=>e.jsx("div",{className:b("flex flex-col space-y-2 text-center sm:text-left",c),...i});Y.displayName="SheetHeader";const Z=({className:c,...i})=>e.jsx("div",{className:b("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",c),...i});Z.displayName="SheetFooter";const ee=P.forwardRef(({className:c,...i},d)=>e.jsx(K,{ref:d,className:b("text-lg font-semibold text-maintext",c),...i}));ee.displayName=K.displayName;const $e=P.forwardRef(({className:c,...i},d)=>e.jsx(_,{ref:d,className:b("text-sm text-muted-foreground",c),...i}));$e.displayName=_.displayName;const Fe=({open:c,onOpenChange:i,onSelectVoucher:d})=>{var T,V;const{profile:y}=H(),v=(T=y==null?void 0:y.data)==null?void 0:T.id,{data:l,isLoading:k,isError:q}=Le(v||"",{}),o=t=>{navigator.clipboard.writeText(t).then(()=>{R.success(`Đã sao chép mã: ${t}`),d(t),i(!1)}).catch(h=>{R.error("Không thể sao chép mã.")})},N=t=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0}).format(t),C=t=>new Intl.DateTimeFormat("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"}).format(new Date(t)),D=(t,h)=>t==="PERCENTAGE"?`${h}%`:N(h),p=(V=l==null?void 0:l.data)==null?void 0:V.vouchers;return e.jsx(Se,{open:c,onOpenChange:i,children:e.jsxs(Ce,{className:"sm:max-w-4xl max-h-[80vh] overflow-hidden",children:[e.jsxs(De,{children:[e.jsxs(Te,{className:"flex items-center gap-2",children:[e.jsx(j.Icon,{path:je,size:.7,className:"text-primary"}),"Danh sách mã giảm giá"]}),e.jsx(Ve,{children:"Chọn mã giảm giá bạn muốn áp dụng cho đơn hàng"})]}),e.jsx(X,{className:"max-h-[60vh] overflow-y-auto",children:k?e.jsx("div",{className:"space-y-2 py-4",children:[...Array(5)].map((t,h)=>e.jsx(ye,{className:"h-16 w-full"},h))}):q?e.jsx("p",{className:"text-red-500 text-center py-4",children:"Lỗi khi tải danh sách mã giảm giá."}):!p||p.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"Bạn không có mã giảm giá nào khả dụng."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-2",children:p.map(t=>{const h=new Date(t.endDate)<new Date,w=t.status==="KHONG_HOAT_DONG",E=t.quantity-t.usedCount<=0,x=h||w||E;return e.jsxs("div",{className:`relative flex flex-col overflow-hidden border rounded-lg p-4 transition-all hover:shadow-md ${x?"bg-muted/30 border-dashed opacity-60":"bg-card border-primary/20 hover:border-primary/50"}`,children:[x&&e.jsx("div",{className:"absolute top-2 right-2 z-10",children:e.jsx(Ae,{variant:"destructive",className:"text-sm",children:h?"Đã hết hạn":w?"Ngừng hoạt động":"Hết lượt"})}),e.jsxs("div",{className:"space-y-3 flex flex-col flex-1",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-primary",children:t.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mã: ",e.jsx("span",{className:"font-mono bg-primary/10 px-1 rounded",children:t.code})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Giá trị giảm:"}),e.jsx("span",{className:"font-bold text-primary text-lg",children:D(t.discountType,t.discountValue)})]}),t.discountType==="PERCENTAGE"&&t.maxDiscount&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Tối đa:"}),e.jsx("span",{className:"text-sm",children:N(t.maxDiscount)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Đơn tối thiểu:"}),e.jsx("span",{className:"text-sm",children:N(t.minOrderValue||0)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Hết hạn:"}),e.jsx("span",{children:C(t.endDate)})]}),t.quantity<1/0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Còn lại:"}),e.jsx("span",{children:t.quantity-t.usedCount})]})]}),e.jsx("div",{className:"flex justify-end items-end h-full flex-1 flex-col ",children:e.jsxs(f,{variant:x?"outline":"default",className:"w-full gap-2",onClick:()=>o(t.code),disabled:x,children:[e.jsx(j.Icon,{path:Ne,size:.7}),x?"Không thể sử dụng":"Chọn mã này"]})})]})]},t.id)})})})]})})},Je=({open:c,onOpenChange:i})=>{var B;const d=oe(),v=de().pathname,{showToast:l}=qe(),{profile:k}=H(),q=(B=k==null?void 0:k.data)==null?void 0:B.id,{items:o,removeFromCart:N,updateQuantity:C,appliedVoucher:D,voucherDiscount:p,setAppliedVoucher:T,removeVoucher:V,subtotal:t,tax:h,shipping:w,total:E}=Ie(),[x,L]=S.useState(""),[I,z]=S.useState(!1),[se,G]=S.useState(!1),[A,g]=S.useState({}),te=Ee();S.useEffect(()=>{const s={};o.forEach(a=>{A[a.id]||(s[a.id]=a.quantity.toString())}),Object.keys(s).length>0&&g(a=>({...a,...s}))},[o]);const ae=(s,a)=>{const n=o.find(r=>r.id===s);if(!n)return;if(a===""){g(r=>({...r,[s]:a}));return}const m=parseInt(a)||0;if(m<0){l({title:"Lỗi",message:"Số lượng không thể âm",type:"error"}),g(r=>({...r,[s]:n.quantity.toString()}));return}if(n.stock&&m>n.stock){l({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${n.stock})`,type:"error"}),g(r=>({...r,[s]:n.stock.toString()}));return}g(r=>({...r,[s]:a}))},ne=s=>{const a=o.find(r=>r.id===s);if(!a)return;const n=A[s],m=parseInt(n)||0;if(m<=0){l({title:"Lỗi",message:"Số lượng phải lớn hơn 0",type:"error"}),g(r=>({...r,[s]:a.quantity.toString()}));return}if(a.stock&&m>a.stock){l({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${a.stock})`,type:"error"}),g(r=>({...r,[s]:a.stock.toString()}));return}C(s,m)},$=(s,a)=>{const n=o.find(r=>r.id===s);if(!n)return;const m=n.quantity+a;if(m<=0){N(s);return}if(n.stock&&m>n.stock){l({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${n.stock})`,type:"error"});return}C(s,m),g(r=>({...r,[s]:m.toString()}))},F=async()=>{if(!x.trim()){l({title:"Lỗi",message:"Vui lòng nhập mã giảm giá",type:"error"});return}if(!q){l({title:"Lỗi",message:"Vui lòng đăng nhập để sử dụng mã giảm giá",type:"error"});return}try{z(!0);const s=await te.mutateAsync({code:x,orderValue:t});if(s.success&&s.data.voucher){const a=s.data.voucher;T({code:a.code,discount:s.data.discountValue,voucherId:a.id,type:a.type,value:a.value,maxDiscount:a.maxDiscount}),L(""),l({title:"Thành công",message:`Áp dụng mã giảm giá ${a.code} thành công`,type:"success"})}else l({title:"Lỗi",message:s.message||"Mã giảm giá không hợp lệ",type:"error"})}catch(s){l({title:"Lỗi",message:s.message||"Không thể kiểm tra mã giảm giá",type:"error"})}finally{z(!1)}},ie=()=>{V(),l({title:"Thành công",message:"Đã xóa mã giảm giá",type:"success"})},re=s=>{L(s)},le=async()=>{try{if(o.length===0){l({title:"Lỗi",message:"Giỏ hàng trống",type:"error"});return}R.info("Đang chuyển đến trang thanh toán"),d("/checkout/shipping"),i(!1)}catch(s){console.error("Error during checkout:",s),l({title:"Lỗi",message:"Đã có lỗi xảy ra khi xử lý đơn hàng",type:"error"})}};return e.jsxs(e.Fragment,{children:[e.jsx(Re,{open:c,onOpenChange:i,children:e.jsxs(W,{className:"w-full sm:max-w-2xl flex flex-col text-maintext p-4 pr-3",side:"right",children:[e.jsx(Y,{className:"border-b pb-4",children:e.jsxs(ee,{children:["Giỏ hàng của bạn (",o.length,")"]})}),o.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"Giỏ hàng của bạn đang trống"}),e.jsx(f,{onClick:()=>i(!1),className:"mt-4",children:"Tiếp tục mua sắm"})]}):e.jsx(X,{className:"flex-1 my-4 pr-2",children:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-4 pr-4",children:o.map(s=>e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"relative h-24 w-24 bg-muted rounded overflow-hidden",children:e.jsx("img",{src:me(s.image),alt:s.name,className:"object-contain"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between  mb-2",children:[e.jsx("h4",{className:"font-medium line-clamp-1",children:s.name}),e.jsx("button",{onClick:()=>N(s.id),className:"text-muted-foreground hover:text-destructive text-sm text-red-error",children:e.jsx(j.Icon,{path:he,size:.7})})]}),e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center justify-between mb-2",children:[e.jsxs("span",{children:["Thương hiệu: ",s.brand]}),s.stock!==void 0&&e.jsxs("span",{className:`ml-2 text-xs px-2 py-0.5 rounded-full ${s.stock>10?"bg-green-100 text-green-700":s.stock>0?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:["Tồn kho: ",s.stock]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center border rounded",children:[e.jsx("button",{className:"px-2 py-1 text-sm hover:bg-muted transition-colors",onClick:()=>$(s.id,-1),children:e.jsx(j.Icon,{path:xe,size:.7})}),e.jsx(O,{type:"number",min:"1",max:s.stock,value:A[s.id]||s.quantity,onChange:a=>ae(s.id,a.target.value),onBlur:()=>ne(s.id),className:`w-16 h-8 text-center border-0 focus:ring-0 text-sm ${s.stock&&s.quantity>=s.stock?"bg-green-50 text-green-800":""}`,title:s.stock?`Tồn kho: ${s.stock}`:void 0}),e.jsx("button",{className:"px-2 py-1 text-sm hover:bg-muted transition-colors",onClick:()=>$(s.id,1),disabled:s.stock?s.quantity>=s.stock:!1,children:e.jsx(j.Icon,{path:ue,size:.7})})]}),e.jsxs("div",{children:[s.hasDiscount&&s.originalPrice&&e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm line-through text-muted-foreground block",children:u(s.originalPrice)}),e.jsx("span",{className:"font-medium text-green-600",children:u(s.price)}),s.discountPercent&&e.jsxs("span",{className:"text-sm text-green-600 ml-1",children:["(-",s.discountPercent,"%)"]})]}),!s.hasDiscount&&e.jsx("span",{className:"font-medium",children:u(s.price)})]})]})]})]},s.id))}),e.jsxs("div",{className:"border-t pt-4 space-y-4 mt-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(ge,{mode:"wait",children:D?e.jsxs(Q.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},className:"flex items-center justify-between p-3 border border-green-200 bg-green-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j.Icon,{path:pe,size:.7,className:"text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm text-green-800",children:D.code}),e.jsxs("div",{className:"text-sm text-green-600",children:["Giảm ",u(p)]})]})]}),e.jsx(f,{size:"sm",variant:"ghost",onClick:ie,className:"h-8 w-8 p-0 rounded-full text-green-600 hover:bg-green-100",children:e.jsx(j.Icon,{path:fe,size:.7})})]},"applied-voucher"):e.jsxs(Q.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{placeholder:"Mã giảm giá",className:"flex-1",value:x,onChange:s=>L(s.target.value),onKeyPress:s=>{s.key==="Enter"&&F()}}),e.jsx(f,{variant:"default",onClick:F,disabled:I||!x.trim(),className:"px-4",children:I?"Đang kiểm tra...":"Áp dụng"})]}),e.jsx(f,{variant:"link",className:"text-sm text-primary p-0 h-auto",onClick:()=>G(!0),children:"Xem danh sách mã giảm giá"})]},"voucher-input")})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-sm font-semibold",children:"Tạm tính"}),e.jsx("span",{children:u(t)})]}),(()=>{const s=o.reduce((a,n)=>n.hasDiscount&&n.originalPrice?a+(n.originalPrice-n.price)*n.quantity:a,0);return s>0?e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Tiết kiệm từ khuyến mãi"}),e.jsxs("span",{children:["-",u(s)]})]}):null})(),p>0&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Giảm giá voucher"}),e.jsxs("span",{children:["-",u(p)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-sm font-semibold",children:"Thuế VAT (5%)"}),e.jsx("span",{children:u(h)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-muted-foreground text-sm font-semibold",children:["Phí vận chuyển",w===0&&e.jsx("span",{className:"text-green-600 ml-1",children:"(Miễn phí)"})]}),e.jsx("span",{children:u(w)})]}),e.jsx(Pe,{}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{className:"text-sm font-semibold",children:"Tổng"}),e.jsx("span",{className:"text-base font-semibold",children:u(E)})]})]}),e.jsxs(Z,{className:"flex gap-2 items-center",children:[e.jsx(f,{variant:"outline",className:"w-full",onClick:()=>{i(!1),v.includes("products")||d("/products")},children:"Tiếp tục mua hàng"}),e.jsx(f,{className:"w-full",onClick:le,disabled:I||o.length===0,children:I?"Đang xử lý...":"Thanh toán"})]})]})]})})]})}),e.jsx(Fe,{open:se,onOpenChange:G,onSelectVoucher:re})]})};export{Je as C};
