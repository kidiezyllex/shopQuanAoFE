import{n as e,j as s,o as t,p as a,q as n,r as i,O as r,D as l}from"./ui-vendor-CFM_MCUz.js";import{r as o,u as c,e as d,b as m}from"./react-vendor-B55MjJUH.js";import{k as x,m as h,u,B as p,l as g,I as f,y as j}from"./index-BHeY-5EX.js";import{ao as y,t as N,a7 as v,a6 as b,a5 as k,ah as w,ap as C,Z as S,a1 as T}from"./icons-vendor-BrsZP2ku.js";import{S as D}from"./scroll-area-CfH0A0Iz.js";import{u as q}from"./useCartStore-nn8gyhXY.js";import{S as V}from"./separator-CIUDwsOv.js";import{u as I}from"./useToast-DwJRzuOq.js";import{f as L}from"./formatters-BtOGY0AI.js";import{a as z,u as O}from"./voucher-C38MW_cY.js";import{D as E,a as G,b as P,c as A,d as $}from"./dialog-Va24CY58.js";import{B as F}from"./badge-BeHegjHt.js";import{S as _}from"./skeleton-4G_X8bY4.js";import{A as R,m as H}from"./heavy-vendor-BfN2pHnQ.js";const K=e,B=t,M=o.forwardRef((({className:e,...t},a)=>s.jsx(r,{className:x("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...t,ref:a})));M.displayName=r.displayName;const X=h("fixed z-50 gap-4 bg-background p-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Z=o.forwardRef((({side:e="right",className:t,children:i,...r},l)=>s.jsxs(B,{children:[s.jsx(M,{}),s.jsxs(a,{ref:l,className:x(X({side:e}),t),...r,children:[s.jsxs(n,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[s.jsx(y,{className:"h-6 w-6"}),s.jsx("span",{className:"sr-only",children:"Close"})]}),i]})]})));Z.displayName=a.displayName;const Q=({className:e,...t})=>s.jsx("div",{className:x("flex flex-col space-y-2 text-center sm:text-left",e),...t});Q.displayName="SheetHeader";const U=({className:e,...t})=>s.jsx("div",{className:x("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...t});U.displayName="SheetFooter";const Y=o.forwardRef((({className:e,...t},a)=>s.jsx(i,{ref:a,className:x("text-lg font-semibold text-maintext",e),...t})));Y.displayName=i.displayName;o.forwardRef((({className:e,...t},a)=>s.jsx(l,{ref:a,className:x("text-sm text-muted-foreground",e),...t}))).displayName=l.displayName;const J=({open:e,onOpenChange:t,onSelectVoucher:a})=>{var n,i;const{profile:r}=u(),l=null==(n=null==r?void 0:r.data)?void 0:n.id,{data:o,isLoading:c,isError:d}=O(l||"",{}),m=e=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",maximumFractionDigits:0}).format(e),x=null==(i=null==o?void 0:o.data)?void 0:i.vouchers;return s.jsx(E,{open:e,onOpenChange:t,children:s.jsxs(G,{className:"sm:max-w-4xl max-h-[80vh] overflow-hidden",children:[s.jsxs(P,{children:[s.jsxs(A,{className:"flex items-center gap-2",children:[s.jsx(N.Icon,{path:S,size:.7,className:"text-primary"}),"Danh sách mã giảm giá"]}),s.jsx($,{children:"Chọn mã giảm giá bạn muốn áp dụng cho đơn hàng"})]}),s.jsx(D,{className:"max-h-[60vh] overflow-y-auto",children:c?s.jsx("div",{className:"space-y-2 py-4",children:[...Array(5)].map(((e,t)=>s.jsx(_,{className:"h-16 w-full"},t)))}):d?s.jsx("p",{className:"text-red-500 text-center py-4",children:"Lỗi khi tải danh sách mã giảm giá."}):x&&0!==x.length?s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-2",children:x.map((e=>{const n=new Date(e.endDate)<new Date,i="KHONG_HOAT_DONG"===e.status,r=e.quantity-e.usedCount<=0,l=n||i||r;return s.jsxs("div",{className:"relative flex flex-col overflow-hidden border rounded-lg p-4 transition-all hover:shadow-md "+(l?"bg-muted/30 border-dashed opacity-60":"bg-card border-primary/20 hover:border-primary/50"),children:[l&&s.jsx("div",{className:"absolute top-2 right-2 z-10",children:s.jsx(F,{variant:"destructive",className:"text-sm",children:n?"Đã hết hạn":i?"Ngừng hoạt động":"Hết lượt"})}),s.jsxs("div",{className:"space-y-3 flex flex-col flex-1",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-bold text-primary",children:e.name}),s.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mã: ",s.jsx("span",{className:"font-mono bg-primary/10 px-1 rounded",children:e.code})]})]}),s.jsxs("div",{className:"space-y-2 text-sm",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Giá trị giảm:"}),s.jsx("span",{className:"font-bold text-primary text-lg",children:(c=e.type,d=e.value,"PERCENTAGE"===c?`${d}%`:m(d))})]}),"PERCENTAGE"===e.type&&e.maxDiscount&&s.jsxs("div",{className:"flex justify-between text-sm",children:[s.jsx("span",{className:"text-muted-foreground",children:"Tối đa:"}),s.jsx("span",{className:"text-sm",children:m(e.maxDiscount)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Đơn tối thiểu:"}),s.jsx("span",{className:"text-sm",children:m(e.minOrderValue||0)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Hết hạn:"}),s.jsx("span",{children:(o=e.endDate,new Intl.DateTimeFormat("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"}).format(new Date(o)))})]}),e.quantity<1/0&&s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground",children:"Còn lại:"}),s.jsx("span",{children:e.quantity-e.usedCount})]})]}),s.jsx("div",{className:"flex justify-end items-end h-full flex-1 flex-col ",children:s.jsxs(p,{variant:l?"outline":"default",className:"w-full gap-2",onClick:()=>{return s=e.code,void navigator.clipboard.writeText(s).then((()=>{j.success(`Đã sao chép mã: ${s}`),a(s),t(!1)})).catch((e=>{j.error("Không thể sao chép mã.")}));var s},disabled:l,children:[s.jsx(N.Icon,{path:T,size:.7}),l?"Không thể sử dụng":"Chọn mã này"]})})]})]},e.id);var o,c,d}))}):s.jsx("p",{className:"text-muted-foreground text-center py-8",children:"Bạn không có mã giảm giá nào khả dụng."})})]})})},W=({open:e,onOpenChange:t})=>{var a;const n=c(),i=d().pathname,{showToast:r}=I(),{profile:l}=u(),o=null==(a=null==l?void 0:l.data)?void 0:a.id,{items:x,removeFromCart:h,updateQuantity:y,appliedVoucher:S,voucherDiscount:T,setAppliedVoucher:O,removeVoucher:E,subtotal:G,tax:P,shipping:A,total:$}=q(),[F,_]=m.useState(""),[B,M]=m.useState(!1),[X,W]=m.useState(!1),[ee,se]=m.useState({}),te=z();m.useEffect((()=>{const e={};x.forEach((s=>{ee[s.id]||(e[s.id]=s.quantity.toString())})),Object.keys(e).length>0&&se((s=>({...s,...e})))}),[x]);const ae=(e,s)=>{const t=x.find((s=>s.id===e));if(!t)return;const a=t.quantity+s;a<=0?h(e):t.stock&&a>t.stock?r({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${t.stock})`,type:"error"}):(y(e,a),se((s=>({...s,[e]:a.toString()}))))},ne=async()=>{if(F.trim())if(o)try{M(!0);const e=await te.mutateAsync({code:F,orderValue:G});if(e.success&&e.data.voucher){const s=e.data.voucher;O({code:s.code,discount:e.data.discountValue,voucherId:s.id,type:s.type,value:s.value,maxDiscount:s.maxDiscount}),_(""),r({title:"Thành công",message:`Áp dụng mã giảm giá ${s.code} thành công`,type:"success"})}else r({title:"Lỗi",message:e.message||"Mã giảm giá không hợp lệ",type:"error"})}catch(e){r({title:"Lỗi",message:e.message||"Không thể kiểm tra mã giảm giá",type:"error"})}finally{M(!1)}else r({title:"Lỗi",message:"Vui lòng đăng nhập để sử dụng mã giảm giá",type:"error"});else r({title:"Lỗi",message:"Vui lòng nhập mã giảm giá",type:"error"})};return s.jsxs(s.Fragment,{children:[s.jsx(K,{open:e,onOpenChange:t,children:s.jsxs(Z,{className:"w-full sm:max-w-2xl flex flex-col text-maintext p-4 pr-3",side:"right",children:[s.jsx(Q,{className:"border-b pb-4",children:s.jsxs(Y,{children:["Giỏ hàng của bạn (",x.length,")"]})}),0===x.length?s.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center",children:[s.jsx("p",{className:"text-muted-foreground",children:"Giỏ hàng của bạn đang trống"}),s.jsx(p,{onClick:()=>t(!1),className:"mt-4",children:"Tiếp tục mua sắm"})]}):s.jsx(D,{className:"flex-1 my-4 pr-2",children:s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"space-y-4 pr-4",children:x.map((e=>s.jsxs("div",{className:"flex gap-4",children:[s.jsx("div",{className:"relative h-24 w-24 bg-muted rounded overflow-hidden",children:s.jsx("img",{src:g(e.image),alt:e.name,className:"object-contain"})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex justify-between  mb-2",children:[s.jsx("h4",{className:"font-medium line-clamp-1",children:e.name}),s.jsx("button",{onClick:()=>h(e.id),className:"text-muted-foreground hover:text-destructive text-sm text-red-error",children:s.jsx(N.Icon,{path:v,size:.7})})]}),s.jsxs("div",{className:"text-sm text-muted-foreground flex items-center justify-between mb-2",children:[s.jsxs("span",{children:["Thương hiệu: ",e.brand]}),void 0!==e.stock&&s.jsxs("span",{className:"ml-2 text-xs px-2 py-0.5 rounded-full "+(e.stock>10?"bg-green-100 text-green-700":e.stock>0?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"),children:["Tồn kho: ",e.stock]})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center border rounded",children:[s.jsx("button",{className:"px-2 py-1 text-sm hover:bg-muted transition-colors",onClick:()=>ae(e.id,-1),children:s.jsx(N.Icon,{path:b,size:.7})}),s.jsx(f,{type:"number",min:"1",max:e.stock,value:ee[e.id]||e.quantity,onChange:s=>((e,s)=>{const t=x.find((s=>s.id===e));if(!t)return;if(""===s)return void se((t=>({...t,[e]:s})));const a=parseInt(s)||0;return a<0?(r({title:"Lỗi",message:"Số lượng không thể âm",type:"error"}),void se((s=>({...s,[e]:t.quantity.toString()})))):t.stock&&a>t.stock?(r({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${t.stock})`,type:"error"}),void se((s=>({...s,[e]:t.stock.toString()})))):void se((t=>({...t,[e]:s})))})(e.id,s.target.value),onBlur:()=>(e=>{const s=x.find((s=>s.id===e));if(!s)return;const t=ee[e],a=parseInt(t)||0;return a<=0?(r({title:"Lỗi",message:"Số lượng phải lớn hơn 0",type:"error"}),void se((t=>({...t,[e]:s.quantity.toString()})))):s.stock&&a>s.stock?(r({title:"Lỗi",message:`Số lượng không thể vượt quá tồn kho (${s.stock})`,type:"error"}),void se((t=>({...t,[e]:s.stock.toString()})))):void y(e,a)})(e.id),className:"w-16 h-8 text-center border-0 focus:ring-0 text-sm "+(e.stock&&e.quantity>=e.stock?"bg-green-50 text-green-800":""),title:e.stock?`Tồn kho: ${e.stock}`:void 0}),s.jsx("button",{className:"px-2 py-1 text-sm hover:bg-muted transition-colors",onClick:()=>ae(e.id,1),disabled:!!e.stock&&e.quantity>=e.stock,children:s.jsx(N.Icon,{path:k,size:.7})})]}),s.jsxs("div",{children:[e.hasDiscount&&e.originalPrice&&s.jsxs("div",{className:"text-right",children:[s.jsx("span",{className:"text-sm line-through text-muted-foreground block",children:L(e.originalPrice)}),s.jsx("span",{className:"font-medium text-green-600",children:L(e.price)}),e.discountPercent&&s.jsxs("span",{className:"text-sm text-green-600 ml-1",children:["(-",e.discountPercent,"%)"]})]}),!e.hasDiscount&&s.jsx("span",{className:"font-medium",children:L(e.price)})]})]})]})]},e.id)))}),s.jsxs("div",{className:"border-t pt-4 space-y-4 mt-4",children:[s.jsx("div",{className:"space-y-2",children:s.jsx(R,{mode:"wait",children:S?s.jsxs(H.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},className:"flex items-center justify-between p-3 border border-green-200 bg-green-50 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N.Icon,{path:w,size:.7,className:"text-green-600"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-sm text-green-800",children:S.code}),s.jsxs("div",{className:"text-sm text-green-600",children:["Giảm ",L(T)]})]})]}),s.jsx(p,{size:"sm",variant:"ghost",onClick:()=>{E(),r({title:"Thành công",message:"Đã xóa mã giảm giá",type:"success"})},className:"h-8 w-8 p-0 rounded-full text-green-600 hover:bg-green-100",children:s.jsx(N.Icon,{path:C,size:.7})})]},"applied-voucher"):s.jsxs(H.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(f,{placeholder:"Mã giảm giá",className:"flex-1",value:F,onChange:e=>_(e.target.value),onKeyPress:e=>{"Enter"===e.key&&ne()}}),s.jsx(p,{variant:"default",onClick:ne,disabled:B||!F.trim(),className:"px-4",children:B?"Đang kiểm tra...":"Áp dụng"})]}),s.jsx(p,{variant:"link",className:"text-sm text-primary p-0 h-auto",onClick:()=>W(!0),children:"Xem danh sách mã giảm giá"})]},"voucher-input")})}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground text-sm font-semibold",children:"Tạm tính"}),s.jsx("span",{children:L(G)})]}),(()=>{const e=x.reduce(((e,s)=>s.hasDiscount&&s.originalPrice?e+(s.originalPrice-s.price)*s.quantity:e),0);return e>0?s.jsxs("div",{className:"flex justify-between text-green-600",children:[s.jsx("span",{className:"text-sm font-semibold",children:"Tiết kiệm từ khuyến mãi"}),s.jsxs("span",{children:["-",L(e)]})]}):null})(),T>0&&s.jsxs("div",{className:"flex justify-between text-green-600",children:[s.jsx("span",{className:"text-sm font-semibold",children:"Giảm giá voucher"}),s.jsxs("span",{children:["-",L(T)]})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{className:"text-muted-foreground text-sm font-semibold",children:"Thuế VAT (5%)"}),s.jsx("span",{children:L(P)})]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("span",{className:"text-muted-foreground text-sm font-semibold",children:["Phí vận chuyển",0===A&&s.jsx("span",{className:"text-green-600 ml-1",children:"(Miễn phí)"})]}),s.jsx("span",{children:L(A)})]}),s.jsx(V,{}),s.jsxs("div",{className:"flex justify-between font-medium",children:[s.jsx("span",{className:"text-sm font-semibold",children:"Tổng"}),s.jsx("span",{className:"text-base font-semibold",children:L($)})]})]}),s.jsxs(U,{className:"flex gap-2 items-center",children:[s.jsx(p,{variant:"outline",className:"w-full",onClick:()=>{t(!1),i.includes("products")||n("/products")},children:"Tiếp tục mua hàng"}),s.jsx(p,{className:"w-full",onClick:async()=>{try{if(0===x.length)return void r({title:"Lỗi",message:"Giỏ hàng trống",type:"error"});j.info("Đang chuyển đến trang thanh toán"),n("/checkout/shipping"),t(!1)}catch(e){r({title:"Lỗi",message:"Đã có lỗi xảy ra khi xử lý đơn hàng",type:"error"})}},disabled:B||0===x.length,children:B?"Đang xử lý...":"Thanh toán"})]})]})]})})]})}),s.jsx(J,{open:X,onOpenChange:W,onSelectVoucher:e=>{_(e)}})]})};export{W as C};
